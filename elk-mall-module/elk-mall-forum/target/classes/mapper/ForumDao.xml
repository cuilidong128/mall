<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.forum.dao.ForumDao">
    <resultMap type="com.mall.forum.modle.Forum" id="BaseResultMap">
        <result property="id" column="forum_id" jdbcType="BIGINT"/>
        <result property="lastPostId" column="forum_last_post_id" jdbcType="BIGINT"/>
        <result property="name" column="forum_name" jdbcType="VARCHAR"/>
        <result property="displayOrder" column="forum_order" jdbcType="INTEGER"/>
        <result property="description" column="forum_description" jdbcType="BOOLEAN"/>
        <result property="moderated" column="forum_moderated" jdbcType="BOOLEAN"/>
        <result property="allowAnonymousPosts" column="forum_allow_anonymous_posts" jdbcType="VARCHAR"/>

        <association property="category" resultMap="com.mall.forum.dao.CategoryDao.BaseResultMap"/>

    </resultMap>

    <select id="selectById" resultMap="BaseResultMap">
       SELECT forum_id, forum_name, categories_id, forum_desc, forum_order, forum_topics, forum_last_post_id, moderated
	FROM jforum_forums
	WHERE forum_id = #{forumId}
    </select>



    <select id="selectAll" resultMap="BaseResultMap">
        SELECT forum_id, forum_name, forum_description, forum_last_post_id, forum_moderated
        FROM jforum_forums
        ORDER BY forum_order ASC
    </select>

    <insert id="addNew" parameterType="com.mall.forum.modle.Forum" useGeneratedKeys="true" keyProperty="id">
        insert into jforum_forums
        (
        `categories_id`,
        `forum_name`,
        `forum_desc`,
        `forum_order`,
        `moderated`
        )
        values
        (
        #{categoriesId},
        #{name},
        #{description},
        #{displayOrder},
        #{moderated}
        )
    </insert>


    <select id="selectAllForPermissions" resultType="map">
       SELECT forum_id AS forumId, forum_name AS forumName FROM jforum_forums ORDER BY forum_name
    </select>


    <select id="statsFirstPostTime" resultType="map">
       SELECT MIN(post_time) AS postTime FROM jforum_posts WHERE post_time > 0
    </select>

    <select id="statsFirstRegisteredUserTime" resultType="map">
        SELECT MIN(user_regdate) AS userRegdate FROM jforum_users WHERE user_regdate > 0
    </select>

    <select id="lastPostInfo" resultType="map">
        SELECT post_time, p.topic_id, t.topic_replies, post_id, u.user_id, username
	FROM jforum_posts p, jforum_users u, jforum_topics t , jforum_forums f
	WHERE t.forum_id = f.forum_id
	AND t.topic_id = p.topic_id
	AND f.forum_last_post_id = t.topic_last_post_id
	AND t.topic_last_post_id = p.post_id
	AND p.forum_id = ?
	AND p.user_id = u.user_id
    AND p.need_moderate = 0
    </select>

    <select id="totalMessages" resultType="Integer">
       SELECT COUNT(1) as total_messages FROM jforum_posts WHERE need_moderate = 0
    </select>


    <select id="getTotalPosts" resultType="Integer">
        SELECT COUNT(1) as totalPosts FROM jforum_posts WHERE  forum_id = #{forumId}
    </select>

    <!-- Forum Wacth -->
    <insert id="subscribeUser" parameterType="com.mall.forum.modle.ForumWatch" useGeneratedKeys="true" keyProperty="id">
        insert into jforum_forums_watch
        (
        `forum_id`,
        `user_id`
        )
        values
        (
        #{forumId},
        #{userId}
        )
    </insert>

    <select id="isUserSubscribed" resultType="Integer">
       SELECT user_id  FROM jforum_forums_watch WHERE forum_id = #{forumId} AND user_id = #{userId}
    </select>


</mapper>