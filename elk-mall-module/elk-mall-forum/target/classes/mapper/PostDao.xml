<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.forum.dao.PostDao">
    <resultMap type="com.mall.forum.modle.Post" id="BaseResultMap">
        <result property="id" column="post_id" jdbcType="BIGINT"/>
        <result property="forumId" column="forum_id" jdbcType="BIGINT"/>
        <result property="topicId" column="topic_id" jdbcType="BIGINT"/>
        <result property="userId" column="user_id" jdbcType="BIGINT"/>
        <result property="text" column="post_text" jdbcType="VARCHAR"/>
        <result property="subject" column="post_subject" jdbcType="VARCHAR"/>
        <result property="bbCodeEnabled" column="enable_bbcode" jdbcType="BOOLEAN"/>
        <result property="htmlEnabled" column="enable_html" jdbcType="BOOLEAN"/>
        <result property="smiliesEnabled" column="enable_smilies" jdbcType="BOOLEAN"/>
        <result property="signatureEnabled" column="enable_sig" jdbcType="BOOLEAN"/>
        <result property="userIp" column="poster_ip" jdbcType="VARCHAR"/>
        <result property="moderate" column="need_moderate" jdbcType="BOOLEAN"/>
        <result property="hasAttachments" column="attach" jdbcType="BOOLEAN"/>
        <result property="editCount" column="post_edit_count" jdbcType="INTEGER"/>
        <result property="editDate" column="post_edit_time" jdbcType="BIGINT"/>
        <result property="postDate" column="post_date" jdbcType="TIMESTAMP"/>

        <collection property="attachments"
        resultMap="com.mall.forum.dao.AttachmentDao.BaseResultMap" />

    </resultMap>

    <select id="selectAllByTopicByLimit" resultMap="BaseResultMap">
    SELECT p.post_id, topic_id, forum_id, p.user_id, post_time, poster_ip, enable_bbcode, p.attach,
	enable_html, enable_smilies, enable_sig, post_edit_time, post_edit_count, status, pt.post_subject, pt.post_text, username, p.need_moderate
	FROM jforum_posts p, jforum_posts_text pt, jforum_users u
	WHERE p.post_id = pt.post_id
	AND topic_id = ?
	AND p.user_id = u.user_id
	AND p.need_moderate = 0
	ORDER BY post_time ASC
	LIMIT ?, ?
    </select>


    <select id="selectByUserByLimit" resultMap="BaseResultMap">
        SELECT p.post_id, topic_id, forum_id, p.user_id, post_time, poster_ip, enable_bbcode, p.attach,
	enable_html, enable_smilies, enable_sig, post_edit_time, post_edit_count, status, pt.post_subject, pt.post_text, username, p.need_moderate
	FROM jforum_posts p, jforum_posts_text pt, jforum_users u
	WHERE p.post_id = pt.post_id
	AND p.user_id = u.user_id
	AND p.user_id = ?
	AND p.need_moderate = 0
	AND forum_id IN(:fids:)
	ORDER BY p.post_id DESC
	LIMIT ?, ?
    </select>

    <select id="selectById" resultMap="BaseResultMap">
      SELECT p.post_id, topic_id, forum_id, p.user_id, post_time, poster_ip, enable_bbcode, enable_html,
	  enable_smilies, enable_sig, post_edit_time, post_edit_count, status, pt.post_subject, pt.post_text, username, p.attach, p.need_moderate
	  FROM jforum_posts p, jforum_posts_text pt, jforum_users u
	  WHERE p.post_id = pt.post_id
	  AND p.post_id = ?
	  AND p.user_id = u.user_id
    </select>


    <delete id="deletePost" >
       DELETE FROM jforum_posts WHERE post_id = #{postId}
    </delete>

    <delete id="deletePostText" >
        DELETE FROM jforum_posts_text WHERE post_id = #{postId}
    </delete>

    <update id="updatePost" parameterType="com.mall.forum.modle.Post">
        UPDATE jforum_posts
        <set>
            <if test="topicId != null">`topic_id` = #{topicId}, </if>
            <if test="forumId != null">`forum_id` = #{forumId} </if>
            <if test="bbCodeEnabled != null">`enable_bbcode` = #{bbCodeEnabled} </if>
            <if test="htmlEnabled != null">`enable_html` = #{htmlEnabled} </if>
            <if test="smiliesEnabled != null">`enable_smilies` = #{smiliesEnabled} </if>
            <if test="signatureEnabled != null">`enable_sig` = #{signatureEnabled} </if>
            <if test="editDate != null">`post_edit_time` = #{editDate} </if>
            <if test="editCount != null">`post_edit_count` = #{editCount} </if>
            <if test="userIp != null">`poster_ip` = #{userIp} </if>
        </set>
        WHERE post_id  = #{postId}
    </update>

    <update id="updatePostText" parameterType="com.mall.forum.modle.Post">
        UPDATE jforum_posts_text
        <set>
            <if test="text != null">`post_text` = #{text}, </if>
            <if test="postSubject != null">`post_subject` = #{postSubject} </if>
        </set>
        WHERE post_id  = #{postId}
    </update>


    <insert id="addNewPost" parameterType="com.mall.forum.modle.Post" useGeneratedKeys="true" keyProperty="id">
      INSERT INTO jforum_posts (topic_id, forum_id, user_id, post_time, poster_ip, enable_bbcode, enable_html, enable_smilies, enable_sig, post_edit_time, need_moderate)
	VALUES (#{topicId}, #{forumId}, #{userId}, #{postTime}, #{userIp}, #{bbCodeEnabled}, #{htmlEnabled}, #{smiliesEnabled}, #{signatureEnabled}, NOW(), #{moderate})
    </insert>

    <select id="countPostAttachments" resultType="Integer">
       SELECT COUNT(1) AS total FROM jforum_posts where user_id = #{userIp} AND forum_id IN (:fids:) AND need_moderate = 0
    </select>

    <update id="setForumByTopic" parameterType="com.mall.forum.modle.Post">
        UPDATE jforum_posts
        <set>
            <if test="forumId != null">`forum_id` = #{forumId}, </if>
        </set>
        WHERE topic_id  = #{topicId}
    </update>

    <select id="deleteByTopic" resultType="map">
       SELECT post_id, user_id FROM jforum_posts WHERE topic_id = #{topicId}
    </select>

</mapper>