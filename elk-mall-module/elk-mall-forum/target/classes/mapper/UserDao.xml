<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.forum.dao.UserDao">
    <resultMap type="com.mall.forum.modle.User" id="BaseResultMap">
        <result property="id" column="user_id" jdbcType="BIGINT"/>
        <result property="totalPosts" column="user_posts" jdbcType="INTEGER"/>
        <result property="attachSignature" column="user_attachsig" jdbcType="BOOLEAN"/>
        <result property="htmlEnabled" column="user_allowhtml" jdbcType="BOOLEAN"/>
        <result property="bbCodeEnabled" column="user_allowbbcode" jdbcType="BOOLEAN"/>
        <result property="smiliesEnabled" column="user_allowsmilies" jdbcType="BOOLEAN"/>
        <result property="avatarEnabled" column="user_allowavatar" jdbcType="BOOLEAN"/>
        <result property="privateMessagesEnabled" column="user_allow_pm" jdbcType="BOOLEAN"/>
        <result property="viewOnlineEnabled" column="user_allow_viewonline" jdbcType="BOOLEAN"/>
        <result property="notifyPrivateMessages" column="user_notify_pm" jdbcType="BOOLEAN"/>
        <result property="notifyReply" column="user_notify" jdbcType="BOOLEAN"/>
        <result property="notifyAlways" column="user_notify_always" jdbcType="BOOLEAN"/>
        <result property="notifyText" column="user_notify_text" jdbcType="BOOLEAN"/>
        <result property="name" column="username" jdbcType="VARCHAR"/>
        <result property="password" column="user_password" jdbcType="VARCHAR"/>
        <result property="lastVisit" column="user_lastvisit" jdbcType="TIMESTAMP"/>
        <result property="registrationDate" column="user_regdate" jdbcType="TIMESTAMP"/>
        <result property="email" column="user_email" jdbcType="VARCHAR"/>
        <result property="website" column="user_website" jdbcType="VARCHAR"/>
        <result property="from" column="user_from" jdbcType="VARCHAR"/>
        <result property="signature" column="user_sig" jdbcType="VARCHAR"/>
        <result property="aim" column="user_aim" jdbcType="VARCHAR"/>
        <result property="yim" column="user_yim" jdbcType="VARCHAR"/>
        <result property="msn" column="user_msnm" jdbcType="VARCHAR"/>
        <result property="occupation" column="user_occ" jdbcType="VARCHAR"/>
        <result property="interests" column="user_interests" jdbcType="VARCHAR"/>
        <result property="biography" column="user_biography" jdbcType="VARCHAR"/>
        <result property="gender" column="gender" jdbcType="VARCHAR"/>
        <result property="timezone" column="user_timezone" jdbcType="VARCHAR"/>
        <result property="lang" column="user_lang" jdbcType="VARCHAR"/>
        <result property="dateFormat" column="user_dateformat" jdbcType="VARCHAR"/>
        <result property="viewEmailEnabled" column="user_viewemail" jdbcType="BOOLEAN"/>
        <result property="active" column="user_active" jdbcType="BOOLEAN"/>
        <result property="activationKey" column="user_actkey" jdbcType="VARCHAR"/>
        <result property="isDeleted" column="deleted" jdbcType="BOOLEAN"/>
        <result property="securityHash" column="security_hash" jdbcType="VARCHAR"/>

    </resultMap>

    <select id="selectAll" resultMap="BaseResultMap">
        SELECT user_email, user_id, user_posts, user_regdate, username, deleted, user_karma, user_from,
	user_website, user_viewemail FROM jforum_users ORDER BY user_id
    </select>

    <select id="selectAllByGroup" resultMap="BaseResultMap">
        SELECT user_email, u.user_id, user_posts, user_regdate, username, deleted, user_karma, user_from,
	user_website, user_viewemail
	FROM jforum_users u, jforum_user_groups ug
	WHERE u.user_id = ug.user_id
	AND ug.group_id =  #{groupId}
    </select>

    <select id="selectGroups" resultMap="BaseResultMap">
       SELECT ug.group_id, g.group_name FROM jforum_user_groups ug, jforum_groups g
	WHERE ug.group_id = g.group_id
	AND ug.user_id =  #{userId}
	ORDER BY g.group_id
    </select>

    <select id="pendingActivations" resultMap="BaseResultMap">
        SELECT user_id, username, user_regdate FROM jforum_users WHERE user_actkey IS NOT NULL ORDER BY user_id
    </select>

    <select id="totalUsersByGroup" resultType="java.lang.Integer">
     SELECT COUNT(1) FROM jforum_user_groups WHERE group_id = #{groupId}
    </select>


    <select id="getTotalUnreadPrivateMessages" resultType="java.lang.Integer">
           SELECT COUNT(pm.privmsgs_to_userid) AS private_messages, u.*
    FROM jforum_users u
    LEFT JOIN jforum_privmsgs pm ON pm.privmsgs_type = 1 AND pm.privmsgs_to_userid = u.user_id
    WHERE u.user_id = #{userId}
    GROUP BY pm.privmsgs_to_userid
    </select>


    <update id="saveUserAuthHash">
        UPDATE jforum_users
        <set>
            <if test="securityHash != null">`security_hash` = #{securityHash} </if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <select id="getUserAuthHash" resultType="java.lang.String">
        SELECT security_hash FROM jforum_users WHERE user_id = #{userId}
    </select>


    <update id="deletedStatus" >
        UPDATE jforum_users
        <set>
            <if test="isDeleted != null">`deleted` = #{isDeleted} </if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <update id="activeStatus" >
        UPDATE jforum_users
        <set>
            <if test="active != null">`user_active` = #{active} </if>
        </set>
        WHERE user_id = #{userId}
    </update>

    <select id="isDeleted" resultType="boolean">
        SELECT deleted FROM jforum_users WHERE user_id = #{userId}
    </select>

    <update id="incrementPosts" >
        UPDATE jforum_users
        <set>
            user_posts = user_posts + 1
        </set>
        WHERE user_id = #{userId}
    </update>


    <update id="decrementPosts" >
        UPDATE jforum_users
        <set>
            user_posts = user_posts - 1
        </set>
        WHERE user_id = #{userId}
    </update>

    <update id="saveNewPassword" >
        UPDATE jforum_users
        <set>
            <if test="password != null">`user_password` = #{password}, </if>
            security_hash = null
        </set>
        WHERE user_email = #{email}
    </update>

    <update id="writeLostPasswordHash" >
        UPDATE jforum_users
        <set>
            <if test="securityHash != null">`security_hash` = #{securityHash}</if>
            security_hash = null
        </set>
        WHERE user_email = #{email}
    </update>

    <select id="getUserSecurityHash" resultType="java.lang.Integer">
       SELECT COUNT(1) AS valid FROM jforum_users WHERE security_hash = #{securityHash} AND user_email = #{email}
    </select>


    <select id="isUsernameAvailable" resultType="java.lang.Integer">
        SELECT COUNT(1) AS valid FROM jforum_users WHERE username = #{username} OR user_email = #{email}
    </select>


    <select id="findByUserName" resultMap="BaseResultMap">
      SELECT user_id, username, user_email, deleted FROM jforum_users WHERE
      UPPER(username) LIKE UPPER('%',#{name},'%')
    </select>


    <select id="validateLogin" resultMap="BaseResultMap">
       SELECT u.* FROM jforum_users u WHERE LOWER(username) = LOWER('%',#{username},'%') AND user_password = #{password}
    </select>

    <select id="findByEmail" resultMap="BaseResultMap">
         SELECT * FROM jforum_users WHERE LOWER(user_email) = LOWER(#{email})
    </select>

    <select id="selectByName" resultMap="BaseResultMap">
       SELECT * FROM jforum_users WHERE LOWER(username) = LOWER(?)
    </select>

    <select id="getUsernameByEmail" resultType="String">
        SELECT username FROM jforum_users WHERE user_email = #{email}
    </select>


    <update id="updateUser" parameterType="com.mall.forum.modle.Config">
        UPDATE jforum_users
        <set>
            <if test="aim != null">`user_aim` = #{aim} </if>,
            <if test="gender != null">`gender` = #{gender} </if>,
            <if test="privateMessagesEnabled != null">`user_allow_pm` = #{privateMessagesEnabled} </if>,
            <if test="avatarEnabled != null">`user_allowavatar` = #{avatarEnabled} </if>,
            <if test="bbCodeEnabled != null">`user_allowbbcode` = #{bbCodeEnabled} </if>,
            <if test="htmlEnabled != null">`user_allowhtml` = #{htmlEnabled} </if>,
            <if test="smiliesEnabled != null">`user_allowsmilies` = #{smiliesEnabled} </if>,
            <if test="email != null">`user_email` = #{email} </if>,
            <if test="from != null">`user_from` = #{from} </if>,
            <if test="interests != null">`user_interests` = #{interests} </if>,
            <if test="occupation != null">`user_occ` = #{occupation} </if>,
            <if test="signature != null">`user_sig` = #{signature} </if>,
            <if test="website != null">`user_website` = #{website} </if>,
            <if test="yim != null">`user_yim` = #{yim} </if>,
            <if test="msn != null">`user_msnm` = #{msn} </if>,
            <if test="password != null">`user_password` = #{password} </if>,
            <if test="viewEmailEnabled != null">`user_viewemail` = #{viewEmailEnabled} </if>,
            <if test="notifyReply != null">`user_notify` = #{notifyReply} </if>,
            <if test="attachSignature != null">`user_attachsig` = #{attachSignature} </if>,
            <if test="name != null">`username` = #{name} </if>,
            <if test="lang != null">`user_lang` = #{lang} </if>,
            <if test="notifyPrivateMessages != null">`user_notify_pm` = #{notifyPrivateMessages} </if>,
            <if test="biography != null">`user_biography` = #{biography} </if>,
            <if test="lastVisit != null">`user_lastvisit` = #{lastVisit} </if>,
            <if test="notifyAlways != null">`user_notify_always` = #{notifyAlways} </if>,
            <if test="notifyText != null">`user_notify_text` = #{notifyText} </if>
        </set>
        WHERE user_id =  #{userId}
    </update>



    <insert id="addNew" parameterType="com.mall.forum.modle.User" useGeneratedKeys="true" keyProperty="id">
        insert into jforum_users
        (
         `username`,
         `user_password`,
         `user_email`,
         `user_regdate`,
         `user_actkey`
        )
        values
        (
        #{name},
        #{password},
        #{email},
        #{registrationDate},
        #{activationKey}
        )
    </insert>

</mapper>