<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.forum.dao.AttachmentDao">

    <!--Forum Attachment-->
    <resultMap type="com.mall.forum.modle.Attachment" id="BaseResultMap">
        <result property="id" column="attach_id" jdbcType="BIGINT"/>
        <result property="userId" column="user_id" jdbcType="BIGINT"/>
        <result property="downloadCount" column="download_count" jdbcType="INTEGER"/>
        <result property="physicalFilename" column="physical_filename" jdbcType="VARCHAR"/>
        <result property="realFilename" column="real_filename" jdbcType="INTEGER"/>
        <result property="description" column="description" jdbcType="VARCHAR"/>
        <result property="mimetype" column="mimetype" jdbcType="VARCHAR"/>
        <result property="uploadDate" column="upload_date" jdbcType="TIMESTAMP"/>
        <result property="filesize" column="filesize" jdbcType="INTEGER"/>
        <result property="hasThumb" column="thumb" jdbcType="BOOLEAN"/>
        <result property="fileExtension" column="file_extension" jdbcType="VARCHAR"/>

        <association property="post" resultMap="com.mall.forum.dao.PostDao.BaseResultMap"/>


    </resultMap>

    <!--Forum Quota Limit-->
    <resultMap type="com.mall.forum.modle.AttachmentQuota" id="BaseQuotaResultMap">
        <result property="id" column="id" jdbcType="BIGINT"/>
        <result property="description" column="quota_desc" jdbcType="VARCHAR"/>
        <result property="size" column="quota_limit" jdbcType="INTEGER"/>
        <result property="type" column="quota_type" jdbcType="INTEGER"/>
    </resultMap>

    <insert id="addAttachment" parameterType="com.mall.forum.modle.Attachment" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO jforum_attach (post_id, privmsgs_id, user_id) VALUES (#{postId}, #{privmsgsId}, #{userId})
    </insert>

    <delete id="removeAttachment" >
        DELETE FROM jforum_attach WHERE attach_id = #{attachId}
    </delete>

    <update id="updateAttachment" parameterType="com.mall.forum.modle.Attachment">
        UPDATE jforum_attach
        <set>
            <if test="description != null">`description` = #{description}, </if>
            <if test="download_count != null">`download_count` = #{downloadCount} </if>
        </set>
        WHERE attach_id = #{attachId}
    </update>

    <select id="selectAttachments" resultMap="BaseResultMap">
        SELECT a.attach_id, a.user_id, a.post_id, a.privmsgs_id, d.mimetype, d.physical_filename, d.real_filename,
        d.download_count, d.description, d.filesize, d.upload_date
        FROM jforum_attach a, jforum_attach_desc d
        WHERE a.post_id = ?
        AND a.attach_id = d.attach_id
    </select>

    <select id="selectAttachmentById" resultMap="BaseResultMap">
        SELECT a.attach_id, a.user_id, a.post_id, a.privmsgs_id, d.mimetype, d.physical_filename, d.real_filename,
        d.download_count, d.description, d.filesize, d.upload_time, d.extension_id
        FROM jforum_attach a, jforum_attach_desc d
        WHERE a.attach_id = ?
        AND a.attach_id = d.attach_id
    </select>


    <select id="selectQuotaLimit" resultMap="BaseQuotaResultMap">
        SELECT id, quota_desc, quota_limit, quota_type
        FROM jforum_quota_limit ORDER BY quota_type, quota_limit
    </select>



    <select id="countPostAttachments" resultType="boolean">
         SELECT COUNT(1) FROM jforum_attach WHERE post_id = #{postId}
    </select>

    <select id="selectQuotaLimitByGroup" resultType="boolean">
       SELECT ql.quota_limit_id, ql.quota_desc, ql.quota_limit, ql.quota_type
	FROM jforum_quota_limit ql, jforum_attach_quota at
	WHERE ql.quota_limit_id = at.quota_limit_id
	AND at.group_id = #{groupId}
    </select>



    <delete id="deleteGroupQuota" >
         DELETE FROM jforum_attach_quota
    </delete>

    <insert id="setGroupQuota" parameterType="com.mall.forum.modle.AttachmentQuota" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO jforum_attach_quota (group_id, quota_limit_id) VALUES ( #{groupId}, #{id})
    </insert>


    <insert id="addQuotaLimit" parameterType="com.mall.forum.modle.AttachmentQuota" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO jforum_quota_limit (quota_desc, quota_limit, quota_type) VALUES (#{description}, #{size}, #{type})
    </insert>

    <update id="updateQuotaLimit" parameterType="com.mall.forum.modle.AttachmentQuota">
        UPDATE jforum_quota_limit SET quota_desc = ?, quota_limit = ?, quota_type = ? WHERE quota_limit_id = ?

        <set>
            <if test="description != null">`quota_desc` = #{description}, </if>
            <if test="size != null">`quota_limit` = #{size} ,</if>
            <if test="type != null">`quota_type` = #{type} </if>
        </set>
        WHERE attach_id = #{attachId}
    </update>

    <delete id="removeQuotaLimit" >
        DELETE FROM jforum_quota_limit WHERE quota_limit_id = #{id}
    </delete>












</mapper>